import os
import json
import pandas as pd
import google.generativeai as genai
import streamlit as st
from dotenv import load_dotenv
from transformers import AutoTokenizer, AutoModelForSequenceClassification
import torch

# â€» torch.classes ê´€ë ¨ ì˜¤ë¥˜ íšŒí”¼ìš© ì²˜ë¦¬ (ì£¼ì˜: ì¶”í›„ í•´ë‹¹ ëª¨ë“ˆ ì‚¬ìš© ì‹œ ë¬¸ì œë  ìˆ˜ ìˆìŒ)
import sys
sys.modules["torch.classes"] = None

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. í™˜ê²½ ì„¤ì •: API í‚¤ ë° ëª¨ë¸ ì´ˆê¸°í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load_dotenv()
genai.configure(api_key=os.environ["API_KEY"])

# KoELECTRA ê¸°ë°˜ í…ìŠ¤íŠ¸ ë¶„ë¥˜ê¸° ë¡œë”©
tokenizer = AutoTokenizer.from_pretrained("./koelectra-intent")
model = AutoModelForSequenceClassification.from_pretrained("./koelectra-intent")

def classify(text):
    inputs = tokenizer(text, return_tensors="pt")
    with torch.no_grad():
        outputs = model(**inputs)
    logits = outputs.logits
    predicted_class_id = logits.argmax().item()
    return predicted_class_id  # LABEL_0 â†’ 0, LABEL_1 â†’ 1 (ì •ìˆ˜í˜•ìœ¼ë¡œ ë°˜í™˜ë¨)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. Streamlit ê¸°ë³¸ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(page_title="ê°œì¸ì •ë³´ í•„í„° ë°ëª¨", page_icon="ğŸ”")
st.title("ğŸ” ê°œì¸ì •ë³´ í•„í„° ë°ëª¨")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. ë°ì´í„° ë¡œë”© (ìµœì´ˆ í•œ ë²ˆë§Œ ì‹¤í–‰, ìºì‹œ ì‚¬ìš©)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@st.cache_data
def load_data():
    with open("data.json", "r", encoding="utf-8") as f:
        data = json.load(f)
    json_text = json.dumps(data, ensure_ascii=False, indent=2)
    return json_text

json_text = load_data()
# print(json_text)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3-2. ì‚¬ì´ë“œë°”: í•™ê³¼ ì •ë³´ ìš”ì•½ ë° í•™ìƒ ê°œë³„ ì •ë³´ ë³´ê¸°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@st.cache_data
def extract_departments(json_text):
    """í•™ê³¼ ìš”ì•½ í…Œì´ë¸” ìƒì„±"""
    data = json.loads(json_text)
    departments = [{
        "í•™ê³¼ëª…": d["í•™ê³¼ëª…"],
        "ì†Œì†ëŒ€í•™": d["ì†Œì†ëŒ€í•™"],
        "ê±´ë¬¼í˜¸ì‹¤": d["ê±´ë¬¼í˜¸ì‹¤"],
        "ì „í™”ë²ˆí˜¸": d["ì „í™”ë²ˆí˜¸"],
        "ì›¹ì‚¬ì´íŠ¸": d["ì›¹ì‚¬ì´íŠ¸"],
        "í‰ê· í•™ì ": d["í‰ê· í•™ì "],
        "í•™ìƒ ìˆ˜": len(d["í•™ìƒëª©ë¡"]),
        "í•™ìƒíšŒì¥": d["í•™ìƒíšŒì¥"]
    } for d in data]
    return pd.DataFrame(departments)

@st.cache_data
def get_department_names(json_text):
    data = json.loads(json_text)
    return [dept["í•™ê³¼ëª…"] for dept in data]

@st.cache_data
def get_students_by_department(json_text, dept_name):
    data = json.loads(json_text)
    for dept in data:
        if dept["í•™ê³¼ëª…"] == dept_name:
            return pd.DataFrame(dept["í•™ìƒëª©ë¡"])
    return pd.DataFrame()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì‚¬ì´ë“œë°” êµ¬ì„±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.markdown("## ğŸ« í•™ê³¼ ì •ë³´ ë³´ê¸°")

    # í•™ê³¼ ìš”ì•½ í…Œì´ë¸” ë³´ê¸°
    with st.expander("ğŸ“˜ ì „ì²´ í•™ê³¼ ìš”ì•½"):
        st.markdown("â€» ì´ ì‹œìŠ¤í…œì´ ê¸°ì–µí•˜ê³  ìˆëŠ” ì „ì²´ í•™ê³¼ ì •ë³´ì…ë‹ˆë‹¤.")
        df_summary = extract_departments(json_text)
        st.dataframe(df_summary)

    # ê°œë³„ í•™ê³¼ í•™ìƒ ì •ë³´ ë³´ê¸°
    with st.expander("ğŸ‘¥ í•™ê³¼ë³„ í•™ìƒ ìƒì„¸ ì •ë³´"):
        st.markdown("â€» í…ŒìŠ¤íŠ¸ìš© ê°€ìƒ ê°œì¸ì •ë³´ì…ë‹ˆë‹¤.")

        department_list = get_department_names(json_text)
        selected_dept = st.selectbox("í•™ê³¼ë¥¼ ì„ íƒí•˜ì„¸ìš”", department_list)

        students_df = get_students_by_department(json_text, selected_dept)
        if not students_df.empty:
            st.dataframe(students_df.style.highlight_max("GPA", axis=0).highlight_min("GPA", axis=0))
        else:
            st.info("ì„ íƒí•œ í•™ê³¼ì— í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "chat" not in st.session_state:
    # ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì •ì˜
    prompt_alternative_recommender = "ë„ˆëŠ” ì‚¬ìš©ìì˜ ì§ˆë¬¸ì´ ê°œì¸ì •ë³´ë¥¼ ì¹¨í•´í•˜ì§€ ì•Šë„ë¡, ì§‘ë‹¨ì ì¸ í†µê³„ì— ê´€ë ¨ëœ ìš°íšŒ ì§ˆë¬¸ì„ ì¶”ì²œí•˜ëŠ” ì—­í• ì„ í•´. ë‹µì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ í•´ì¤˜."
    prompt = "ëª¨ë“  ëŒ€ë‹µì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ í•´ì¤˜."
    prompt_output_filter = """ì…ë ¥ë°›ì€ í…ìŠ¤íŠ¸ì—ì„œ ê°œì¸ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´ ê°œì¸ì •ë³´ ë³´í˜¸ë¡œ ì¸í•´ ì•Œë ¤ì¤„ ìˆ˜ ì—†ë‹¤ê³  ë§í•´.
ê°œì¸ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆì§€ ì•Šë‹¤ë©´ ì…ë ¥ë°›ì€ ê°’ì„ ê·¸ëŒ€ë¡œ ì¶œë ¥í•´ì¤˜. í‰ê°€ ê³¼ì •ì€ ì¶œë ¥í•˜ì§€ ë§ê³ , ê²°ê³¼ë§Œ ì¶œë ¥í•´."""

    # Gemini ì„¸ì…˜ ì´ˆê¸°í™”
    model = genai.GenerativeModel("gemini-1.5-flash")
    st.session_state.chat_alternative = model.start_chat(history=[{"role": "user", "parts": [prompt_alternative_recommender]}])
    st.session_state.chat = model.start_chat(history=[
        {"role": "user", "parts": [prompt]},
        {"role": "user", "parts": [f"ë‹¤ìŒì€ ì„œìš¸ëŒ€í•™êµì— ê´€ë ¨ëœ ì •ë³´ì…ë‹ˆë‹¤:\n\n{json_text}"]}
    ])
    st.session_state.chat_output_filter = model.start_chat(history=[{"role": "user", "parts": [prompt_output_filter]}])
    st.session_state.chat_history = []

# ì„¸ì…˜ì—ì„œ ì±„íŒ… ê°ì²´ ë¶ˆëŸ¬ì˜¤ê¸°
chat_alternative = st.session_state.chat_alternative
chat = st.session_state.chat
chat_output_filter = st.session_state.chat_output_filter

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. ê¸°ì¡´ ëŒ€í™” ì¶œë ¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
for role, message in st.session_state.chat_history:
    with st.chat_message("user" if role == "user" else "ai"):
        st.markdown(message)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6. ì‚¬ìš©ì ì…ë ¥ ë° í•„í„°ë§ ë¡œì§
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

user_input = st.chat_input("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6-1. ì˜ˆì‹œ ì§ˆë¬¸ ì œê³µ (ê°œì¸ì •ë³´ ì§ˆë¬¸ vs ì¼ë°˜ ì •ë³´ íƒìƒ‰ ì§ˆë¬¸)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

example_questions_sensitive = [
    "ê¹€í•˜ìœ¤ í•™ìƒì˜ í•™ë²ˆ ì•Œë ¤ì¤˜",
    "ì¥ìœ¤ì„œì˜ ì£¼ì†Œê°€ ë­ì•¼?",
    "ì‹¬ë¦¬í•™ê³¼ í•™ìƒ ì¤‘ì—ì„œ GPA ì œì¼ ë†’ì€ ì‚¬ëŒì€ ëˆ„êµ¬ì•¼?",
    "ì‚¬íšŒí•™ê³¼ í•™ìƒíšŒì¥ì˜ ì „í™”ë²ˆí˜¸ ì•Œë ¤ì¤˜"
]

example_questions_general = [
    "êµ­ì‚¬í•™ê³¼ í•™ìƒíšŒì¥ì€ ëˆ„êµ¬ì•¼?",
    "ì‹¬ë¦¬í•™ê³¼ í‰ê·  í•™ì  ì•Œë ¤ì¤˜",
    "ì‚¬íšŒë³µì§€í•™ê³¼ëŠ” ì–´ëŠ ê±´ë¬¼ì— ìˆì–´?",
    "ì»´í“¨í„°ê³µí•™ë¶€ í•™ìƒ ìˆ˜ëŠ” ëª‡ ëª…ì´ì•¼?",
    "ì–¸ì–´í•™ê³¼ì˜ ì›¹ì‚¬ì´íŠ¸ ì£¼ì†Œ ì•Œë ¤ì¤˜"
]

st.markdown("ğŸ’¬ **ì˜ˆì‹œ ì§ˆë¬¸ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”!**")

# ë¹„ì¹¨í•´ ì§ˆë¬¸
st.markdown("âœ… **ê°œì¸ì •ë³´ ë¹„ì¹¨í•´ ì§ˆë¬¸ (LABEL_0):**")
cols_0 = st.columns(len(example_questions_general))
for i, q in enumerate(example_questions_general):
    if cols_0[i].button(q, key=f"label0_{i}"):
        user_input = q # ì˜ˆì‹œ ì§ˆë¬¸ì„ ì„ íƒí•˜ë©´ ì…ë ¥ì°½ì— ìë™ ì…ë ¥ë˜ë„ë¡ ì²˜ë¦¬

# ê°œì¸ì •ë³´ ì¹¨í•´ ì§ˆë¬¸
st.markdown("ğŸš« **ê°œì¸ì •ë³´ ì¹¨í•´ ì§ˆë¬¸ (LABEL_1):**")
cols_1 = st.columns(len(example_questions_sensitive))
for i, q in enumerate(example_questions_sensitive):
    if cols_1[i].button(q, key=f"label1_{i}"):
        user_input = q # ì˜ˆì‹œ ì§ˆë¬¸ì„ ì„ íƒí•˜ë©´ ì…ë ¥ì°½ì— ìë™ ì…ë ¥ë˜ë„ë¡ ì²˜ë¦¬

if user_input:
    # ì…ë ¥ëœ ì‚¬ìš©ì ë©”ì‹œì§€ ì¶œë ¥ ë° ì €ì¥
    st.chat_message("user").markdown(user_input)
    st.session_state.chat_history.append(("user", user_input))
    
    # ì…ë ¥ í•„í„°ë§ (KoELECTRA ë¶„ë¥˜ê¸° ì‚¬ìš©)
    with st.spinner("Input Filterê°€ ë™ì‘ ì¤‘ì…ë‹ˆë‹¤..."):
        label_id = classify(user_input)
        label = f"LABEL_{label_id}"
        print("â˜‘ï¸", label)

    # í•„í„°ë§ ê²°ê³¼ì— ë”°ë¥¸ ë¶„ê¸° ì²˜ë¦¬
    if label == 'LABEL_1':  # ê°œì¸ì •ë³´ í¬í•¨ ì§ˆë¬¸ â†’ ìš°íšŒ ì§ˆë¬¸ ìƒì„±
        with st.spinner("Geminiê°€ ì‘ë‹µ ì¤‘ì…ë‹ˆë‹¤..."):
            try:
                response = chat_alternative.send_message(user_input)
                print("âœ–ï¸ Alternative Response", response)
                ai_reply = response.text
            except Exception as e:
                ai_reply = f"âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}"
                
    else:  # ê°œì¸ì •ë³´ ë¹„í¬í•¨ ì§ˆë¬¸ â†’ Gemini â†’ Output Filter
        with st.spinner("Geminiê°€ ì‘ë‹µ ì¤‘ì…ë‹ˆë‹¤..."):
            try:
                response = chat.send_message(user_input)
                print("ğŸ”¥ First Response", response.text)

                response_final = chat_output_filter.send_message(response.text)
                print("ğŸ¤– Final Response", response_final.text)

                ai_reply = response_final.text
            except Exception as e:
                ai_reply = f"âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 7. í•„í„°ë§ ê³¼ì • ìš”ì•½ (í´ë¦­í•´ì„œ ë³´ê¸°)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    with st.expander("ğŸ” í•„í„°ë§ ê³¼ì • ìì„¸íˆ ë³´ê¸°"):
        st.markdown(f"""
        **1ë‹¨ê³„: ì…ë ¥ í•„í„°ë§**  
        - KoELECTRA ë¶„ë¥˜ê¸°ë¡œ ì…ë ¥ ë¬¸ì¥ì„ ë¶„ì„í•˜ì—¬ 'ê°œì¸ì •ë³´ ì§ˆë¬¸' ì—¬ë¶€ë¥¼ íŒë³„í•©ë‹ˆë‹¤.  
        - ì˜ˆì¸¡ ê²°ê³¼: `â˜‘ï¸ {label}`
        """)

        st.markdown("""
        **2ë‹¨ê³„: ëŒ€ë‹µ ìƒì„±**  
        - ê°œì¸ì •ë³´ ì§ˆë¬¸ì¼ ê²½ìš° â†’ Geminiì—ê²Œ ìš°íšŒ ì§ˆë¬¸ì„ ìš”ì²­  
        - ê°œì¸ì •ë³´ê°€ ì•„ë‹ ê²½ìš° â†’ Geminiì—ê²Œ ì§ì ‘ ì‘ë‹µ ìƒì„± ìš”ì²­
        - ğŸ”¥ ì´ˆê¸° ì‘ë‹µ:
        """)
        st.code(f"{response.text if 'response' in locals() else '-'}", language="text")

        st.markdown("""
        **3ë‹¨ê³„: ì¶œë ¥ í•„í„°ë§**  
        - Geminiì˜ ì‘ë‹µì—ì„œ ê°œì¸ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆì§€ëŠ” ì•Šì€ì§€ Output Filterë¡œ ë‹¤ì‹œ ì ê²€í•©ë‹ˆë‹¤.
        - ğŸ¤– ìµœì¢… ì‘ë‹µ:
        """)
        st.code(f"{response_final.text if 'response_final' in locals() else '-'}", language="text")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 8. ìµœì¢… ì‘ë‹µ ì¶œë ¥ ë° ëŒ€í™” ê¸°ë¡ ì €ì¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    st.chat_message("ai").markdown(ai_reply)
    st.session_state.chat_history.append(("ai", ai_reply))
